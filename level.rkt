#lang racket/base
(require "helpers.rkt"
         "logger.rkt"
         "range.rkt"
         "score.rkt"
         "velocity.rkt")
(provide MakeDefaultLevel MakeSpeedyLevel)


(define (MakeDefaultLevel #:log [-log (MakeLogger)])
  (let ((level (MakeLevel #:log -log)))
    (level 'friction!                 -10)
    (level 'gravity!                  (MakeVelocity 0 (* -0.94 2)))
    (level 'player-strafe!            20)
    (level 'player-jump!              (MakeVelocity 0 70))
    (level 'player-bounce!            (MakeRange 10 30))
    (level 'obstacle-speed!           (MakeRange -20 -5))
    (level 'obstacle-size!            (MakeRange 50 200))
    (level 'obstacle-x!               (MakeRange 100  700))
    (level 'obstacle-y!               (MakeRange 0 300))
    (level 'obstacle-cleanup-offset!  -100)
    (level 'obstacle-generate-offset! 800)
    level))

(define (MakeSpeedyLevel #:log [-log (MakeLogger)])
  (let ((level (MakeLevel #:log -log)))
    (level 'friction!                 -5)
    (level 'gravity!                  (MakeVelocity 0 (* -0.94 10)))
    (level 'player-strafe!            30)
    (level 'player-jump!              (MakeVelocity 0 170))
    (level 'player-bounce!            (MakeRange 10 30))
    (level 'player-bounce!            (MakeRange 30 60))
    (level 'obstacle-speed!           (MakeRange -50 -20))
    (level 'obstacle-size!            (MakeRange 50 200))
    (level 'obstacle-x!               (MakeRange 100  700))
    (level 'obstacle-y!               (MakeRange 0 300))
    (level 'obstacle-cleanup-offset!  -100)
    (level 'obstacle-generate-offset! 800)
    level))

(define (MakeLevel #:log [-log (MakeLogger)])
  (let ((-gravity   #f)
        (-friction  #f)
        (-pstrafe   #f)
        (-pjump     #f)
        (-pbounce   #f)
        (-ospeed    #f)
        (-osize     #f)
        (-ox        #f)
        (-oy        #f)
        (-ocleanup  #f)
        (-ogenerate #f)
        (-score     (MakeScore #:log -log)))
    (define (dispatch msg . args)
      (apply
        (case msg
          ((score)                     get-score)
          ((friction)                  get-friction)
          ((gravity)                   get-gravity)
          ((player-strafe)             get-pstrafe)
          ((player-jump)               get-pjump)
          ((player-bounce)             get-pbounce)
          ((obstacle-speed)            get-ospeed)
          ((obstacle-size)             get-osize)
          ((obstacle-x)                get-ox)
          ((obstacle-y)                get-oy)
          ((obstacle-cleanup-offset)   get-ocleanup)
          ((obstacle-generate-offset)  get-ogenerate)
          ((friction!)                 set-friction!)
          ((gravity!)                  set-gravity!)
          ((player-strafe!)            set-pstrafe!)
          ((player-jump!)              set-pjump!)
          ((player-bounce!)            set-pbounce!)
          ((obstacle-speed!)           set-ospeed!)
          ((obstacle-size!)            set-osize!)
          ((obstacle-x!)               set-ox!)
          ((obstacle-y!)               set-oy!)
          ((obstacle-cleanup-offset!)  set-ocleanup!)
          ((obstacle-generate-offset!) set-ogenerate!)
          (else
            (-log 'fatal "method missing" msg kClass)))
        args))

    ;; Properties
    (define (get-score)     -score)
    (define (get-friction)  (or -friction  (warn-nil -log 'friction kClass)))
    (define (get-gravity)   (or -gravity   (warn-nil -log 'gravity kClass)))
    (define (get-pstrafe)   (or -pstrafe   (warn-nil -log 'player-strafe kClass)))
    (define (get-pjump)     (or -pjump     (warn-nil -log 'player-jump kClass)))
    (define (get-pbounce)   (or -pbounce   (warn-nil -log 'player-bounce kClass)))
    (define (get-ospeed)    (or -ospeed    (warn-nil -log 'obstacle-speed kClass)))
    (define (get-osize)     (or -osize     (warn-nil -log 'obstacle-size kClass)))
    (define (get-ox)        (or -ox        (warn-nil -log 'obstacle-x kClass)))
    (define (get-oy)        (or -oy        (warn-nil -log 'obstacle-y kClass)))
    (define (get-ocleanup)  (or -ocleanup  (warn-nil -log 'obstacle-cleanup-offset kClass)))
    (define (get-ogenerate) (or -ogenerate (warn-nil -log 'obstacle-generate-offset kClass)))

    (define (set-friction! friction)   (set! -friction friction))
    (define (set-gravity! gravity)     (set! -gravity gravity))
    (define (set-pstrafe! pstrafe)     (set! -pstrafe pstrafe))
    (define (set-pjump! pjump)         (set! -pjump pjump))
    (define (set-pbounce! pbounce)     (set! -pbounce pbounce))
    (define (set-ospeed! ospeed)       (set! -ospeed ospeed))
    (define (set-osize! osize)         (set! -osize osize))
    (define (set-ox! ox)               (set! -ox ox))
    (define (set-oy! oy)               (set! -oy oy))
    (define (set-ocleanup! ocleanup)   (set! -ocleanup ocleanup))
    (define (set-ogenerate! ogenerate) (set! -ogenerate ogenerate))

    ;; Private
    dispatch))


(define (warn-nil logger sym type)
  (logger 'warn "property not initialized" sym type))

(define kClass        'Level)
(define kNullNumber   0)
(define kNullRange    (MakeRange 0 0))
(define kNullVelocity (MakeVelocity 0 0))
